# src/eval/report.py
import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))
from tools.persistence import init_db, load_memory
from datetime import datetime

def build_report_for_user(user_id: str, conn=None) -> str:
    conn = conn or init_db()
    mem = load_memory(conn, user_id)
    diagnostics = mem.get("diagnostics", [])
    last_diag = diagnostics[-1] if diagnostics else {}
    last_quiz = mem.get("last_quiz", {}).get("answers", {})
    pre_score = last_diag.get("score_percent", 0)
    post_score = last_quiz.get("score_percent", 0)
    delta = post_score - pre_score
    mastery = mem.get("topic_mastery", {}).get("linear_equations", None)
    ts = datetime.utcnow().isoformat() + "Z"

    report = [
        f"Adaptive Learning Coach - Evaluation Report (user: {user_id})",
        f"Generated at: {ts}",
        "",
        f"Pre-assessment score: {pre_score}%",
        f"Post-quiz score: {post_score}%",
        f"Delta (post - pre): {delta} percentage points",
        f"Current stored mastery for linear_equations: {mastery}%",
        "",
        "Summary:",
    ]

    if delta >= 10:
        report.append(f"- The learner improved by {delta} points after the lesson and quiz. This meets the target of >=10 points for basic remediation.")
    elif delta > 0:
        report.append(f"- The learner improved by {delta} points; consider additional practice sessions to reach target improvement.")
    else:
        report.append(f"- No improvement observed. Recommend reviewing lesson content or trying alternate explanation styles; consider human tutor intervention.")

    report.append("")
    report.append("Notes: This report is autogenerated. See README for reproduction instructions.")
    return "\n".join(report)

if __name__ == "__main__":
    import sys
    user = sys.argv[1] if len(sys.argv) > 1 else "student_test_01"
    print(build_report_for_user(user))
